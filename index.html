<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ecossistema Docente ‚Äî V3.1 (Diagn√≥stico + Debate)</title>

  <style>
    :root{
      --bg0:#f6f7fb;
      --bg1:#eef2ff;
      --card:#ffffff;
      --stroke: rgba(17,24,39,.10);
      --txt:#0f172a;
      --muted: rgba(15,23,42,.70);

      --accent:#2563eb;
      --accent2:#7c3aed;

      --r:#2563eb; /* pesquisa */
      --e:#16a34a; /* extens√£o */
      --t:#f59e0b; /* ensino */
      --g:#7c3aed; /* gest√£o */
      --i:#ef4444; /* inova√ß√£o */
      --b:#475569; /* burocracia */
      --m:#0ea5e9; /* sa√∫de mental */

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 12px 34px rgba(15,23,42,.10);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1100px 760px at 15% 10%, rgba(37,99,235,.10) 0%, transparent 55%),
        radial-gradient(1000px 720px at 85% 15%, rgba(124,58,237,.10) 0%, transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--txt);
    }

    header{
      max-width:1250px;
      margin:0 auto;
      padding:18px 16px 10px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:46px; height:46px; border-radius:14px;
      background: linear-gradient(135deg, rgba(37,99,235,.22), rgba(124,58,237,.18));
      border:1px solid rgba(15,23,42,.10);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .logo:before{
      content:"";
      position:absolute; inset:-20px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 45%);
      transform: rotate(12deg);
    }

    h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    .subtitle{
      margin:4px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      max-width:820px;
    }

    .top-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button{
      background: #fff;
      border: 1px solid rgba(15,23,42,.12);
      color: var(--txt);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: .15s transform, .15s box-shadow, .15s background;
      font-weight: 850;
      box-shadow: 0 6px 18px rgba(15,23,42,.06);
    }
    button:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(15,23,42,.10); }
    button:active{ transform: translateY(0px); }
    .primary{
      background: linear-gradient(135deg, rgba(37,99,235,.14), rgba(124,58,237,.12));
      border-color: rgba(37,99,235,.18);
    }
    .danger{
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.20);
    }

    main{
      max-width:1250px;
      margin:0 auto;
      padding:0 16px 44px;
      display:grid; gap:14px;
      grid-template-columns: 1.08fr .92fr;
    }
    @media (max-width: 980px){ main{ grid-template-columns:1fr; } }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 14px 10px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .card-h h2{
      margin:0; font-size:14px; letter-spacing:.2px;
      display:flex; gap:10px; align-items:center;
    }
    .pill{
      font-size:12px; color: rgba(15,23,42,.72);
      padding:6px 10px; border-radius:999px;
      background: rgba(15,23,42,.04);
      border: 1px solid rgba(15,23,42,.08);
    }
    .card-b{ padding:14px; }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px 14px 0;
    }
    .tab{
      padding:8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.03);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      user-select:none;
    }
    .tab.active{
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.20);
    }

    .grid2{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    @media (max-width:700px){ .grid2{ grid-template-columns:1fr; } }

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      background: #fff;
      border: 1px solid rgba(15,23,42,.14);
      color: var(--txt);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
    }
    textarea{ min-height:84px; resize:vertical; }

    .q{
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.02);
      margin-bottom:10px;
    }
    .q-title{
      font-weight: 950;
      margin:0 0 8px;
      line-height:1.35;
      font-size:13px;
    }
    .q-sub{
      margin:0 0 10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .scale{ display:flex; align-items:center; gap:10px; }
    .scale input[type="range"]{ flex:1; accent-color: rgba(37,99,235,.9); }
    .scale .v{
      min-width:40px;
      text-align:center;
      font-weight:950;
      background: rgba(15,23,42,.05);
      border:1px solid rgba(15,23,42,.10);
      border-radius: 10px;
      padding:6px 8px;
    }
    .scaleHints{
      display:flex; justify-content:space-between;
      font-size:11px; color:var(--muted);
      margin-top:6px;
    }

    .bar{
      height:10px; border-radius:999px;
      background: rgba(15,23,42,.07);
      border: 1px solid rgba(15,23,42,.10);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, rgba(37,99,235,.85), rgba(124,58,237,.75));
    }

    .kpis{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .kpi{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.02);
    }
    .kpi .v{ font-size:20px; font-weight:990; }
    .kpi .l{ font-size:12px; color:var(--muted); margin-top:2px; line-height:1.3; }

    .story{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.02);
      line-height:1.6;
      font-size:13px;
      color: rgba(15,23,42,.92);
    }
    .quote{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px dashed rgba(15,23,42,.18);
      background: rgba(37,99,235,.05);
      font-size:13px;
      line-height:1.55;
    }

    /* ‚úÖ CANVAS: tipos diferentes (fica bom no PC) */
    .vizGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:980px){ .vizGrid{ grid-template-columns:1fr; } }

    .viz{
      border-radius: 16px;
      border:1px solid rgba(15,23,42,.10);
      background: #fff;
      padding:10px;
    }
    .viz h3{
      margin:0 0 8px;
      font-size: clamp(13px, 1.1vw, 15px);
      font-weight:980;
      letter-spacing:.1px;
      color: rgba(15,23,42,.92);
      display:flex; gap:8px; align-items:center;
    }
    .viz p{
      margin:0 0 10px;
      color:var(--muted);
      font-size: clamp(12px, 1.0vw, 13px);
      line-height:1.35;
    }

    .canvasWrap{
      position:relative;
      width:100%;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
    }
    .canvasWrap.square{ aspect-ratio: 1 / 1; }
    .canvasWrap.wide{ aspect-ratio: 16 / 10; }
    .canvasWrap.gauge{ aspect-ratio: 16 / 11; }
    .canvasWrap.quad{ aspect-ratio: 16 / 10; }

    @media (min-width: 1100px){
      .canvasWrap.square{ max-height: 360px; }
      .canvasWrap.wide{ max-height: 320px; }
      .canvasWrap.gauge{ max-height: 320px; }
      .canvasWrap.quad{ max-height: 320px; }
    }

    canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      touch-action: none; /* para pan/zoom no quadrante */
    }

    .micro{ display:grid; gap:10px; margin-top:10px; }
    .move{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background: #fff;
    }
    .move .ttl{ font-weight:990; margin:0 0 4px; }
    .move .txt{ margin:0; color:var(--muted); font-size:12px; line-height:1.45; }

    /* ‚úÖ Checklist elegante e grande */
    .checkGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:980px){ .checkGrid{ grid-template-columns:1fr; } }

    .checkCard{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.02);
    }
    .checkCard h3{
      margin:0 0 8px;
      font-size:13px;
      font-weight:990;
      display:flex; gap:8px; align-items:center;
    }
    .checkCard .hint{
      margin:0 0 10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .ck{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:8px 10px;
      border-radius: 12px;
      background: #fff;
      border:1px solid rgba(15,23,42,.08);
      margin:8px 0;
    }
    .ck input{
      width:18px; height:18px;
      margin-top:2px;
      accent-color: rgba(37,99,235,.90);
    }
    .ck .txt{
      font-size:13px;
      line-height:1.35;
      color: rgba(15,23,42,.92);
    }
    .ck .txt b{ font-weight:990; }

    .tagrow{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;
      color:var(--muted); font-size:12px;
    }
    .tag{
      display:flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      background: rgba(15,23,42,.03);
      border:1px solid rgba(15,23,42,.08);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:#111; }

    .small{
      font-size:12px; color:var(--muted);
      margin-top:8px;
      line-height:1.35;
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>Ecossistema Docente ‚Äî Diagn√≥stico + Debate (V3.1)</h1>
      <p class="subtitle">
        Um game cr√≠tico para professores: <b>o que eu fa√ßo</b>, <b>o que eu quero ser</b> e <b>o que me captura</b>.
        Aqui, burocracia e sa√∫de mental n√£o s√£o rodap√© ‚Äî s√£o eixo.
      </p>
    </div>
  </div>

  <div class="top-actions">
    <button class="primary" id="btnRun">Gerar diagn√≥stico</button>
    <button id="btnSave">Salvar</button>
    <button id="btnLoad">Carregar</button>
    <button id="btnExport">Exportar painel</button>
    <button class="danger" id="btnReset">Resetar</button>
  </div>
</header>

<main>
  <!-- ESQUERDA -->
  <section class="card">
    <div class="tabs">
      <div class="tab active" data-tab="responder">Responder</div>
      <div class="tab" data-tab="metas">Metas</div>
      <div class="tab" data-tab="perguntas">Perguntas</div>
    </div>

    <div id="tab-responder">
      <div class="card-h">
        <h2>üßæ Identidade & contexto</h2>
        <span class="pill">V3.1 ‚Äî est√°vel no PC</span>
      </div>
      <div class="card-b">
        <div class="grid2">
          <div><label>Nome</label><input id="name" placeholder="Ex.: Ernandes"/></div>
          <div><label>Universidade</label><input id="uni" placeholder="Ex.: UNEMAT"/></div>
          <div><label>Departamento</label><input id="dept" placeholder="Ex.: Ci√™ncias Ambientais"/></div>
          <div><label>Programa(s)</label><input id="prog" placeholder="Ex.: PPGCA, PPGEO..."/></div>

          <div>
            <label>Fase da carreira</label>
            <select id="phase">
              <option value="early">In√≠cio (0‚Äì5 anos)</option>
              <option value="mid">Meio (6‚Äì15 anos)</option>
              <option value="senior">S√™nior (16+ anos)</option>
            </select>
          </div>

          <div><label>Horas ‚Äúreais‚Äù por semana</label><input id="hours" type="number" min="1" max="120" value="45"/></div>
        </div>

        <div style="margin-top:12px;">
          <label>O que mais te puxa hoje? (opcional)</label>
          <textarea id="notes" placeholder="Ex.: reuni√µes, sistemas, relat√≥rios duplicados, press√£o por papers, orienta√ß√µes, comiss√µes, etc."></textarea>
        </div>

        <div style="margin-top:12px;">
          <div class="bar"><i id="pbar"></i></div>
          <div class="small">Progresso: <b><span id="answered">0</span>/<span id="totalQ">0</span></b> respondidas.</div>
        </div>
      </div>
    </div>

    <div id="tab-metas" style="display:none;">
      <div class="card-h">
        <h2>üéØ Metas em 5 anos</h2>
        <span class="pill">defina seu norte (0‚Äì100)</span>
      </div>
      <div class="card-b">
        <div class="grid2">
          <div><label>Pesquisa üî¨</label><input id="goalR" type="number" min="0" max="100" value="70"></div>
          <div><label>Extens√£o üå±</label><input id="goalE" type="number" min="0" max="100" value="75"></div>
          <div><label>Ensino üéì</label><input id="goalT" type="number" min="0" max="100" value="70"></div>
          <div><label>Gest√£o üß≠</label><input id="goalG" type="number" min="0" max="100" value="40"></div>
          <div><label>Inova√ß√£o üöÄ</label><input id="goalI" type="number" min="0" max="100" value="60"></div>
          <div><label>Limite de burocracia aceit√°vel (0‚Äì100)</label><input id="tolB" type="number" min="0" max="100" value="35"></div>
        </div>

        <div style="margin-top:12px;">
          <label>Limite de carga mental toler√°vel (0‚Äì100)</label>
          <input id="tolM" type="number" min="0" max="100" value="45">
          <div class="small">
            Isso serve para o app mostrar: ‚Äúvoc√™ est√° acima do que considera sustent√°vel?‚Äù.
          </div>
        </div>
      </div>

      <div class="card-h">
        <h2>üï∞Ô∏è Seu ‚Äúideal de semana‚Äù (distribui√ß√£o %)</h2>
        <span class="pill">o app normaliza a soma</span>
      </div>
      <div class="card-b">
        <div class="grid2">
          <div><label>% Pesquisa</label><input id="idealR" type="number" min="0" max="100" value="25"></div>
          <div><label>% Extens√£o</label><input id="idealE" type="number" min="0" max="100" value="25"></div>
          <div><label>% Ensino</label><input id="idealT" type="number" min="0" max="100" value="25"></div>
          <div><label>% Gest√£o</label><input id="idealG" type="number" min="0" max="100" value="15"></div>
          <div><label>% Inova√ß√£o</label><input id="idealI" type="number" min="0" max="100" value="10"></div>
          <div><label>% Burocracia (m√°x.)</label><input id="idealB" type="number" min="0" max="100" value="15"></div>
        </div>
      </div>
    </div>

    <div id="tab-perguntas" style="display:none;">
      <div class="card-h">
        <h2>üß† Perguntas (r√©gua 1‚Äì5) ‚Äî pesos ocultos</h2>
        <span class="pill">menos ‚Äúquiz‚Äù, mais espelho</span>
      </div>
      <div class="card-b" id="quiz"></div>
      <div class="card-b">
        <button class="primary" id="btnRun2">Gerar diagn√≥stico</button>
        <div class="small">
          Regra do jogo: responda como voc√™ age <b>sob press√£o</b>.
          Se responder como ‚Äúideal‚Äù, voc√™ n√£o ver√° o sistema te capturando.
        </div>
      </div>
    </div>
  </section>

  <!-- DIREITA -->
  <aside class="card">
    <div class="tabs">
      <div class="tab active" data-rtab="resultados">Resultados</div>
      <div class="tab" data-rtab="plano">Plano</div>
      <div class="tab" data-rtab="check">Checklist</div>
    </div>

    <div id="rtab-resultados">
      <div class="card-h">
        <h2>üìç Painel visual (robusto e leg√≠vel)</h2>
        <span class="pill" id="statusPill">aguardando‚Ä¶</span>
      </div>
      <div class="card-b">
        <div class="vizGrid">
          <div class="viz">
            <h3>üï∏Ô∏è Perfil (Atual vs Desejado)</h3>
            <p>Distribui√ß√£o de energia por eixo. N√£o mede ‚Äúqualidade‚Äù. Mede <b>onde voc√™ vive</b>.</p>
            <div class="canvasWrap square"><canvas id="cvRadar"></canvas></div>
            <div class="tagrow">
              <span class="tag"><i class="dot" style="background:rgba(15,23,42,.90)"></i> Atual</span>
              <span class="tag"><i class="dot" style="background:rgba(15,23,42,.25)"></i> Desejado</span>
            </div>
          </div>

          <div class="viz">
            <h3>üìä Semana (Hoje vs Ideal)</h3>
            <p>Voc√™ v√™ o desvio em segundos. Linha = ideal. Barra = hoje.</p>
            <div class="canvasWrap wide"><canvas id="cvWeek"></canvas></div>
          </div>

          <div class="viz">
            <h3>‚ö´ Burocracia (term√¥metro + fric√ß√£o)</h3>
            <p>Quando isso sobe, o resto vira sobreviv√™ncia. Sem romantizar.</p>
            <div class="canvasWrap gauge"><canvas id="cvBureau"></canvas></div>
          </div>

          <div class="viz">
            <h3>üß† Sa√∫de mental (carga + risco)</h3>
            <p>Indicador de ‚Äúcaptura‚Äù: se voc√™ s√≥ apaga inc√™ndio, nada floresce.</p>
            <div class="canvasWrap gauge"><canvas id="cvMental"></canvas></div>
          </div>

          <div class="viz">
            <h3>üß≠ Impacto √ó Energia (interativo)</h3>
            <p>Hover/Toque para ver detalhes. Arraste para mover. Scroll/pin√ßa para zoom. Duplo clique para reset.</p>
            <div class="canvasWrap quad"><canvas id="cvQuad"></canvas></div>
          </div>

          <div class="viz">
            <h3>‚è≥ Funil de drenos da semana</h3>
            <p>Uma vis√£o simples do que rouba o seu melhor hor√°rio cognitivo.</p>
            <div class="canvasWrap wide"><canvas id="cvFunnel"></canvas></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card-h" style="border:0; padding:0 0 10px;">
          <h2>üìå Diagn√≥stico narrativo</h2>
          <span class="pill">com criticidade</span>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="v" id="kpiCore">‚Äî</div>
            <div class="l">Seu eixo dominante hoje</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiRisk">‚Äî</div>
            <div class="l">Risco de captura (burocracia + carga mental)</div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="story" id="story">Responda e gere o diagn√≥stico.</div>
        <div class="quote" id="quote"></div>
      </div>
    </div>

    <div id="rtab-plano" style="display:none;">
      <div class="card-h">
        <h2>üß≠ Plano (7 / 30 / 90 dias)</h2>
        <span class="pill">execut√°vel + objetivo</span>
      </div>
      <div class="card-b">
        <div class="micro" id="moves"></div>
      </div>
    </div>

    <div id="rtab-check" style="display:none;">
      <div class="card-h">
        <h2>‚úÖ Checklist grande (bonito e √∫til)</h2>
        <span class="pill">marque e volte amanh√£</span>
      </div>
      <div class="card-b">
        <div class="checkGrid" id="checkGrid"></div>

        <div class="checkCard" style="margin-top:12px;">
          <h3>üß© O que √© ser professor universit√°rio (para fechar)</h3>
          <p class="hint">Frases para imprimir/colocar no app como ‚Äúmanifesto‚Äù (sem autoajuda).</p>
          <div id="closing"></div>
        </div>
      </div>
    </div>
  </aside>
</main>

<script>
/* =========================
   UTILIDADES
========================= */
function val(id){ return document.getElementById(id).value; }
function setVal(id,v){ document.getElementById(id).value = (v ?? ""); }

function clampNum(id, min=0, max=100){
  const el = document.getElementById(id);
  let v = Number(el.value);
  if(!Number.isFinite(v)) v = 0;
  v = Math.max(min, Math.min(max, Math.round(v)));
  el.value = v;
  return v;
}
function normalize100(obj){
  const sum = Object.values(obj).reduce((a,b)=>a+b,0);
  const base = Math.max(1, sum);
  const out={};
  for(const k in obj) out[k] = Math.round((obj[k]/base)*100);
  return out;
}

function phaseTxt(){
  const p = document.getElementById("phase").value;
  return p==="early" ? "in√≠cio de carreira" : (p==="mid" ? "meio de carreira" : "fase s√™nior");
}

function topRole(vec){
  const keys=["R","E","T","G","I"];
  return keys.reduce((best,k)=> vec[k] > vec[best] ? k : best, "R");
}
function riskLabel(capture){
  if(capture >= 70) return {txt:"ALTO üî•", cls:"bad"};
  if(capture >= 40) return {txt:"M√âDIO ‚ö†Ô∏è", cls:"warn"};
  return {txt:"BAIXO ‚úÖ", cls:"ok"};
}
function clsColor(cls){
  return cls==="bad" ? "var(--bad)" : (cls==="warn" ? "var(--warn)" : "var(--ok)");
}

/* =========================
   DADOS
========================= */
const EMOJI = {R:"üî¨",E:"üå±",T:"üéì",G:"üß≠",I:"üöÄ",B:"‚ö´",M:"üß†"};
const LABEL = {R:"Pesquisa",E:"Extens√£o",T:"Ensino",G:"Gest√£o",I:"Inova√ß√£o",B:"Burocracia",M:"Sa√∫de mental"};

const COLORS = {
  R:"rgba(37,99,235,.85)",
  E:"rgba(22,163,74,.82)",
  T:"rgba(245,158,11,.88)",
  G:"rgba(124,58,237,.82)",
  I:"rgba(239,68,68,.78)",
  B:"rgba(71,85,105,.75)",
  M:"rgba(14,165,233,.78)",
  ink:"rgba(15,23,42,.92)",
  soft:"rgba(15,23,42,.10)",
  soft2:"rgba(15,23,42,.06)"
};

const QUESTIONS = [
  { id:"q1",  t:"Eu uso meus pr√≥prios artigos e projetos como material vivo de aula (com m√©todo e cr√≠tica).", a:"Nunca", b:"Sempre", w:{R:1.2,T:1.0} },
  { id:"q2",  t:"Eu tenho rotina de escrita/produ√ß√£o que sobrevive √† semana real.", a:"Nunca", b:"Sempre", w:{R:1.5,G:0.2,M:-0.2} },
  { id:"q3",  t:"Minha pesquisa tem uma pergunta-m√£e que d√° coer√™ncia aos projetos (evita dispers√£o por edital).", a:"Nada", b:"Totalmente", w:{R:1.4,G:0.2,M:-0.2} },

  { id:"q4",  t:"Eu enxergo extens√£o como coprodu√ß√£o de conhecimento (n√£o s√≥ evento).", a:"Nada", b:"Totalmente", w:{E:1.3,R:0.4} },
  { id:"q5",  t:"Eu consigo transformar extens√£o em processo cont√≠nuo com indicadores simples e parceiros fixos.", a:"Nunca", b:"Sempre", w:{E:1.4,G:0.6} },

  { id:"q6",  t:"Eu preparo aulas considerando neurodiverg√™ncia (TDAH/TEA) com estrutura e m√∫ltiplas formas de participa√ß√£o.", a:"Nunca", b:"Sempre", w:{T:1.2,M:-0.1} },
  { id:"q7",  t:"Eu adapto materiais para acessibilidade (surdos/cegos/baixa vis√£o/dislexia) ou busco apoio para isso.", a:"Nada", b:"Muito", w:{T:1.2,G:0.3,B:0.1} },
  { id:"q8",  t:"Avalia√ß√£o √© formativa (feedback, rubricas, refa√ß√£o), n√£o puni√ß√£o nem burocracia.", a:"Nunca", b:"Sempre", w:{T:1.3,B:-0.2,M:-0.1} },

  { id:"q9",  t:"Eu uso IA de modo √©tico/pedag√≥gico e ensino limites e transpar√™ncia.", a:"Nunca", b:"Sempre", w:{I:1.0,T:0.6,G:0.2} },
  { id:"q10", t:"Eu tenho pol√≠tica clara para IA na disciplina (o que pode, como declarar e citar uso).", a:"Nunca", b:"Sempre", w:{G:0.6,T:0.8} },
  { id:"q11", t:"Eu transformo ideias em prot√≥tipos e valido com usu√°rios (alunos/territ√≥rio/gest√£o) antes de ‚Äòfechar‚Äô solu√ß√£o.", a:"Nunca", b:"Sempre", w:{I:1.4,E:0.2} },
  { id:"q12", t:"Eu institucionalizo o que crio (documento, treino pessoas, deixo replic√°vel).", a:"Nunca", b:"Sempre", w:{G:0.8,I:0.8} },

  { id:"q13", t:"Eu entendo a universidade como campo de disputa (tempo/recursos/prest√≠gio) e ajo com estrat√©gia sem perder valores.", a:"Nada", b:"Totalmente", w:{G:1.0,B:0.2} },
  { id:"q14", t:"Eu lido com autoria/cr√©ditos/hierarquias com firmeza e √©tica (sem virar c√≠nico).", a:"Nunca", b:"Sempre", w:{G:0.9,M:-0.1} },
  { id:"q15", t:"Eu formo pessoas para serem melhores que eu (delega√ß√£o com confian√ßa + crit√©rio).", a:"Nunca", b:"Sempre", w:{G:0.8,T:0.6,E:0.3} },

  { id:"q16", t:"Minha semana √© engolida por sistemas, formul√°rios, relat√≥rios duplicados e reuni√µes sem decis√£o.", a:"Nada", b:"Totalmente", w:{B:1.7,M:0.4} },
  { id:"q17", t:"Reuni√µes ocupam meu melhor hor√°rio cognitivo.", a:"Nunca", b:"Sempre", w:{B:1.2,M:0.4} },
  { id:"q18", t:"Eu automatizo/templatizo rotinas (relat√≥rios, e-mails, fluxos) para n√£o repetir dor.", a:"Nunca", b:"Sempre", w:{I:0.6,G:0.6,B:-0.7,M:-0.2} },
  { id:"q19", t:"Eu consigo dizer ‚Äòn√£o‚Äô de modo institucionalmente inteligente quando a demanda s√≥ gera ru√≠do.", a:"Nunca", b:"Sempre", w:{G:0.7,B:-0.9,M:-0.2} },

  { id:"q20", t:"Eu durmo o suficiente e n√£o trabalho sempre no modo ‚Äòurg√™ncia‚Äô (meu corpo n√£o virou ferramenta).", a:"Nunca", b:"Sempre", w:{M:-0.9,B:-0.1,G:0.2} },
  { id:"q21", t:"Eu reconhe√ßo sinais de exaust√£o e ajusto o sistema (n√£o s√≥ ‚Äòaguento‚Äô).", a:"Nunca", b:"Sempre", w:{G:0.6,M:-0.7,B:-0.2} },
  { id:"q22", t:"Eu protejo blocos de foco profundo (90‚Äì120 min) pelo menos 2x por semana.", a:"Nunca", b:"Sempre", w:{R:0.7,T:0.5,I:0.5,B:-0.4,M:-0.2} }
];

document.getElementById("totalQ").textContent = QUESTIONS.length;

/* =========================
   QUIZ UI
========================= */
const quizEl = document.getElementById("quiz");

function buildQuiz(){
  quizEl.innerHTML="";
  QUESTIONS.forEach((q, idx)=>{
    const wrap = document.createElement("div");
    wrap.className = "q";

    wrap.innerHTML = `
      <p class="q-title">${idx+1}) ${q.t}</p>
      <p class="q-sub">Use a r√©gua: 1 (discordo/ausente) ‚Üí 5 (concordo/presente). As pontua√ß√µes ficam ocultas.</p>
      <div class="scale">
        <input type="range" min="1" max="5" step="1" value="1" id="${q.id}">
        <div class="v" id="${q.id}_v">1</div>
      </div>
      <div class="scaleHints"><span>${q.a}</span><span>${q.b}</span></div>
    `;

    const rng = wrap.querySelector(`#${q.id}`);
    const valBox = wrap.querySelector(`#${q.id}_v`);
    rng.addEventListener("input", ()=>{
      valBox.textContent = rng.value;
      updateProgress();
    });

    quizEl.appendChild(wrap);
  });
}
buildQuiz();

/* =========================
   PROGRESS
========================= */
function countAnswered(){
  let n=0;
  QUESTIONS.forEach(q=>{
    const v = document.getElementById(q.id).value;
    if(v && Number(v)>=1) n++;
  });
  return n;
}
function updateProgress(){
  const n = countAnswered();
  document.getElementById("answered").textContent = n;
  const pct = Math.round((n/QUESTIONS.length)*100);
  document.getElementById("pbar").style.width = pct + "%";
}
updateProgress();

/* =========================
   COMPUTE
========================= */
function compute(){
  const missing=[];
  const raw = {R:0,E:0,T:0,G:0,I:0,B:0,M:0};

  QUESTIONS.forEach((q, idx)=>{
    const v = Number(document.getElementById(q.id).value);
    if(!Number.isFinite(v) || v<1){ missing.push(idx+1); return; }
    const x = (v-1)/4; // 0..1
    for(const k in q.w){
      raw[k] += x * q.w[k];
    }
  });

  const mainKeys=["R","E","T","G","I"];
  const mainSum = mainKeys.reduce((a,k)=>a + Math.max(0,raw[k]), 0);
  const base = Math.max(0.0001, mainSum);

  const cur = {
    R: Math.round((Math.max(0,raw.R)/base)*100),
    E: Math.round((Math.max(0,raw.E)/base)*100),
    T: Math.round((Math.max(0,raw.T)/base)*100),
    G: Math.round((Math.max(0,raw.G)/base)*100),
    I: Math.round((Math.max(0,raw.I)/base)*100),
    B: Math.max(0, Math.min(100, Math.round((raw.B + 1.4) * 30))),
    M: Math.max(0, Math.min(100, Math.round((raw.M + 1.2) * 30)))
  };

  const goal = {
    R: clampNum("goalR"), E: clampNum("goalE"), T: clampNum("goalT"),
    G: clampNum("goalG"), I: clampNum("goalI"),
    tolB: clampNum("tolB"),
    tolM: clampNum("tolM")
  };

  const ideal = normalize100({
    R: clampNum("idealR"), E: clampNum("idealE"), T: clampNum("idealT"),
    G: clampNum("idealG"), I: clampNum("idealI"), B: clampNum("idealB")
  });

  let currentWeek = {
    R: cur.R, E: cur.E, T: cur.T, G: cur.G, I: cur.I,
    B: Math.min(45, Math.max(10, Math.round(cur.B*0.42)))
  };
  currentWeek = normalize100(currentWeek);

  const frictionB = Math.max(0, Math.round((cur.B - goal.tolB)));
  const frictionM = Math.max(0, Math.round((cur.M - goal.tolM)));
  const capture = Math.min(100, Math.round((cur.B*0.45) + (cur.M*0.40) + (frictionB*0.10) + (frictionM*0.05)));

  const gap = {
    R: goal.R - cur.R,
    E: goal.E - cur.E,
    T: goal.T - cur.T,
    G: goal.G - cur.G,
    I: goal.I - cur.I
  };

  const impact = {
    R:cur.R*0.9 + goal.R*0.1,
    E:cur.E*0.8 + goal.E*0.2,
    T:cur.T*0.85 + goal.T*0.15,
    G:cur.G*0.7 + goal.G*0.3,
    I:cur.I*0.8 + goal.I*0.2
  };

  const energy = {
    R: Math.max(10, 60 - cur.B*0.2 - cur.M*0.25),
    E: Math.max(10, 58 - cur.B*0.2 - cur.M*0.18),
    T: Math.max(10, 55 - cur.B*0.18 - cur.M*0.22),
    G: Math.max(10, 50 - cur.B*0.10 - cur.M*0.12),
    I: Math.max(10, 56 - cur.B*0.18 - cur.M*0.16)
  };

  return {missing, raw, cur, goal, ideal, currentWeek, frictionB, frictionM, capture, gap, impact, energy};
}

/* =========================
   CANVAS ENGINE (SEM DEFORMAR)
========================= */
function setupCanvas(canvas){
  const ctx = canvas.getContext("2d");
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(10, Math.round(rect.width * dpr));
    const h = Math.max(10, Math.round(rect.height * dpr));
    if(canvas.width !== w || canvas.height !== h){
      canvas.width = w;
      canvas.height = h;
    }
    ctx.setTransform(dpr,0,0,dpr,0,0); // desenhar em CSS pixels
  }
  return {ctx, resize};
}

const C = {
  radar: setupCanvas(document.getElementById("cvRadar")),
  week: setupCanvas(document.getElementById("cvWeek")),
  bureau: setupCanvas(document.getElementById("cvBureau")),
  mental: setupCanvas(document.getElementById("cvMental")),
  quad: setupCanvas(document.getElementById("cvQuad")),
  funnel: setupCanvas(document.getElementById("cvFunnel"))
};

function clear(ctx, canvas){
  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,w,h);
}

function roundRect(ctx, x,y,w,h,r, fill=true, stroke=false){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

/* =========================
   DESENHOS
========================= */
function drawRadar(cur, goal){
  const canvas = document.getElementById("cvRadar");
  const {ctx, resize} = C.radar;
  resize();
  clear(ctx, canvas);

  const W = canvas.getBoundingClientRect().width;
  const H = canvas.getBoundingClientRect().height;

  const cx = W*0.50, cy = H*0.56;
  const radius = Math.min(W*0.36, H*0.40);
  const axes = ["R","E","T","G","I"];
  const n = axes.length;

  ctx.strokeStyle = COLORS.soft;
  ctx.lineWidth = 1;
  for(let r=1;r<=5;r++){
    const rr = radius*(r/5);
    ctx.beginPath();
    for(let i=0;i<n;i++){
      const ang = (-Math.PI/2) + (i*(2*Math.PI/n));
      const x = cx + Math.cos(ang)*rr;
      const y = cy + Math.sin(ang)*rr;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.closePath(); ctx.stroke();
  }

  axes.forEach((k,i)=>{
    const ang = (-Math.PI/2) + (i*(2*Math.PI/n));
    const x = cx + Math.cos(ang)*radius;
    const y = cy + Math.sin(ang)*radius;
    ctx.beginPath();
    ctx.moveTo(cx,cy); ctx.lineTo(x,y);
    ctx.strokeStyle = "rgba(15,23,42,.12)";
    ctx.stroke();

    const lx = cx + Math.cos(ang)*(radius+22);
    const ly = cy + Math.sin(ang)*(radius+22);
    ctx.fillStyle = COLORS.ink;
    ctx.font = "900 12px ui-sans-serif, system-ui";
    ctx.textAlign = "center";
    ctx.fillText(`${EMOJI[k]} ${LABEL[k]}`, lx, ly+4);
  });

  function poly(vec, stroke, fill){
    ctx.beginPath();
    axes.forEach((k,i)=>{
      const ang = (-Math.PI/2) + (i*(2*Math.PI/n));
      const val = (vec[k]||0)/100;
      const x = cx + Math.cos(ang)*radius*val;
      const y = cy + Math.sin(ang)*radius*val;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.closePath();
    ctx.strokeStyle = stroke; ctx.lineWidth = 2;
    ctx.stroke();
    ctx.fillStyle = fill;
    ctx.fill();
  }

  poly(goal, "rgba(15,23,42,.25)", "rgba(15,23,42,.06)");
  poly(cur, "rgba(15,23,42,.90)", "rgba(15,23,42,.12)");

  ctx.fillStyle = COLORS.ink;
  ctx.font = "950 13px ui-sans-serif, system-ui";
  ctx.textAlign="left";
  ctx.fillText("Atual vs Desejado", 10, 18);
  ctx.textAlign="left";
}

function drawWeekBars(curW, idealW){
  const canvas = document.getElementById("cvWeek");
  const {ctx, resize} = C.week;
  resize();
  clear(ctx, canvas);

  const W = canvas.getBoundingClientRect().width;
  const H = canvas.getBoundingClientRect().height;

  const keys = ["R","E","T","G","I","B"];
  const left = 110;
  const rightPad = 10;
  const barW = W - left - rightPad;
  const top = 40;
  const rowH = (H-58)/keys.length;

  ctx.fillStyle = COLORS.ink;
  ctx.font = "950 13px ui-sans-serif, system-ui";
  ctx.fillText("Semana ‚Äî Hoje (barra) vs Ideal (linha)", 10, 18);

  keys.forEach((k, idx)=>{
    const y = top + idx*rowH + 10;

    ctx.fillStyle = COLORS.ink;
    ctx.font = "900 12px ui-sans-serif, system-ui";
    ctx.textAlign="left";
    ctx.fillText(`${EMOJI[k]} ${LABEL[k]}`, 10, y+10);

    ctx.fillStyle = COLORS.soft2;
    roundRect(ctx, left, y, barW, 14, 8, true, false);

    const bw = Math.round((curW[k]/100)*barW);
    ctx.fillStyle = COLORS[k] || "rgba(15,23,42,.50)";
    roundRect(ctx, left, y, bw, 14, 8, true, false);

    const ix = left + Math.round((idealW[k]/100)*barW);
    ctx.strokeStyle = "rgba(15,23,42,.55)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(ix, y-4);
    ctx.lineTo(ix, y+18);
    ctx.stroke();

    ctx.fillStyle = "rgba(15,23,42,.70)";
    ctx.font = "800 11px ui-sans-serif, system-ui";
    ctx.textAlign = "right";
    ctx.fillText(`hoje ${curW[k]}% | ideal ${idealW[k]}%`, W-10, y+11);
  });

  ctx.textAlign="left";
}

function drawGauge(canvasId, value, label, color){
  const canvas = document.getElementById(canvasId);
  const pack = canvasId==="cvBureau" ? C.bureau : C.mental;
  const {ctx, resize} = pack;
  resize();
  clear(ctx, canvas);

  const W = canvas.getBoundingClientRect().width;
  const H = canvas.getBoundingClientRect().height;

  const cx = W*0.50, cy = H*0.72;
  const r = Math.min(W*0.38, H*0.58);
  const start = Math.PI*1.02;
  const end = Math.PI*1.98;

  ctx.lineWidth = 16;
  ctx.strokeStyle = COLORS.soft2;
  ctx.beginPath();
  ctx.arc(cx, cy, r, start, end);
  ctx.stroke();

  const seg = [
    {to: 0.40, c:"rgba(22,163,74,.65)"},
    {to: 0.70, c:"rgba(245,158,11,.70)"},
    {to: 1.00, c:"rgba(239,68,68,.65)"}
  ];
  let prev = 0;
  seg.forEach(s=>{
    const a0 = start + (end-start)*prev;
    const a1 = start + (end-start)*s.to;
    ctx.strokeStyle = s.c;
    ctx.beginPath(); ctx.arc(cx,cy,r,a0,a1); ctx.stroke();
    prev = s.to;
  });

  const pct = Math.max(0, Math.min(100, value))/100;
  ctx.strokeStyle = color;
  ctx.beginPath();
  ctx.arc(cx, cy, r, start, start + (end-start)*pct);
  ctx.stroke();

  const ang = start + (end-start)*pct;
  const nx = cx + Math.cos(ang)*(r-6);
  const ny = cy + Math.sin(ang)*(r-6);
  ctx.lineWidth = 2;
  ctx.strokeStyle = "rgba(15,23,42,.75)";
  ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(nx,ny); ctx.stroke();
  ctx.fillStyle = "rgba(15,23,42,.85)";
  ctx.beginPath(); ctx.arc(cx,cy,5,0,Math.PI*2); ctx.fill();

  ctx.fillStyle = COLORS.ink;
  ctx.font = "950 13px ui-sans-serif, system-ui";
  ctx.textAlign="center";
  ctx.fillText(label, cx, 18);

  ctx.font = "990 30px ui-sans-serif, system-ui";
  ctx.fillText(`${Math.round(value)}`, cx, cy-18);

  ctx.fillStyle = "rgba(15,23,42,.65)";
  ctx.font = "800 12px ui-sans-serif, system-ui";
  ctx.fillText("/100", cx, cy+2);
}

const QuadUI = {
  scale: 1,
  offX: 0,
  offY: 0,
  hover: null,
  pinned: null,
  dragging: false,
  lastX: 0,
  lastY: 0
};

function drawQuad(impact, energy){
  const canvas = document.getElementById("cvQuad");
  const {ctx, resize} = C.quad;
  resize();
  clear(ctx, canvas);

  const W = canvas.getBoundingClientRect().width;
  const H = canvas.getBoundingClientRect().height;

  const pad = 46;
  const x0 = pad, y0 = pad;
  const x1 = W-pad, y1 = H-pad;

  ctx.fillStyle = COLORS.ink;
  ctx.font = "950 13px ui-sans-serif, system-ui";
  ctx.textAlign="left";
  ctx.fillText("Impacto √ó Energia (zoom, arraste, hover)", 10, 18);

  ctx.save();
  ctx.translate(QuadUI.offX, QuadUI.offY);
  ctx.translate(W/2, H/2);
  ctx.scale(QuadUI.scale, QuadUI.scale);
  ctx.translate(-W/2, -H/2);

  ctx.strokeStyle = COLORS.soft;
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(x0, y1); ctx.lineTo(x1, y1); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x0, y1); ctx.lineTo(x0, y0); ctx.stroke();

  const mx = x0 + (x1-x0)/2;
  const my = y0 + (y1-y0)/2;
  ctx.strokeStyle = "rgba(15,23,42,.10)";
  ctx.beginPath(); ctx.moveTo(mx, y0); ctx.lineTo(mx, y1); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x0, my); ctx.lineTo(x1, my); ctx.stroke();

  ctx.fillStyle = "rgba(15,23,42,.65)";
  ctx.font = "800 11px ui-sans-serif, system-ui";
  ctx.fillText("Impacto ‚Üí", x1-70, y1+24);
  ctx.save();
  ctx.translate(x0-28, y0+70);
  ctx.rotate(-Math.PI/2);
  ctx.fillText("Energia (sustent√°vel) ‚Üí", 0, 0);
  ctx.restore();

  const keys=["R","E","T","G","I"];
  const pts = [];
  keys.forEach(k=>{
    const ix = (impact[k]||0)/100;
    const ey = (energy[k]||0)/100;
    const px = x0 + ix*(x1-x0);
    const py = y1 - ey*(y1-y0);
    pts.push({k, px, py, impact: Math.round((impact[k]||0)), energy: Math.round((energy[k]||0))});

    ctx.fillStyle = COLORS[k];
    ctx.beginPath(); ctx.arc(px,py,7,0,Math.PI*2); ctx.fill();

    ctx.fillStyle = "rgba(15,23,42,.85)";
    ctx.font = "900 11px ui-sans-serif, system-ui";
    ctx.fillText(`${EMOJI[k]} ${LABEL[k]}`, px+10, py+4);
  });

  ctx.restore();

  canvas.__quadPts = pts;

  const target = QuadUI.pinned || QuadUI.hover;
  if(target){
    const boxW = 260, boxH = 74;
    const bx = Math.min(W - boxW - 12, Math.max(12, target.sx + 12));
    const by = Math.min(H - boxH - 12, Math.max(30, target.sy - 10));

    ctx.fillStyle = "rgba(255,255,255,.97)";
    ctx.strokeStyle = "rgba(15,23,42,.12)";
    ctx.lineWidth = 1;
    roundRect(ctx, bx, by, boxW, boxH, 12, true, true);

    ctx.fillStyle = "rgba(15,23,42,.92)";
    ctx.font = "950 12px ui-sans-serif, system-ui";
    ctx.fillText(`${EMOJI[target.k]} ${LABEL[target.k]}`, bx+12, by+22);

    ctx.fillStyle = "rgba(15,23,42,.70)";
    ctx.font = "850 12px ui-sans-serif, system-ui";
    ctx.fillText(`Impacto: ${target.impact}/100`, bx+12, by+46);
    ctx.fillText(`Energia: ${target.energy}/100`, bx+140, by+46);

    ctx.fillStyle = "rgba(15,23,42,.55)";
    ctx.font = "800 11px ui-sans-serif, system-ui";
    ctx.fillText(QuadUI.pinned ? "fixado (clique para soltar)" : "clique para fixar", bx+12, by+64);
  }
}

function drawFunnel(curW, B, M){
  const canvas = document.getElementById("cvFunnel");
  const {ctx, resize} = C.funnel;
  resize();
  clear(ctx, canvas);

  const W = canvas.getBoundingClientRect().width;
  const H = canvas.getBoundingClientRect().height;

  ctx.fillStyle = COLORS.ink;
  ctx.font = "950 13px ui-sans-serif, system-ui";
  ctx.fillText("Drenos (vis√£o simples da semana)", 10, 18);

  const items = [
    {k:"B", name:"Burocracia", v: curW.B, c: COLORS.B},
    {k:"T", name:"Ensino (operacional)", v: curW.T, c: COLORS.T},
    {k:"G", name:"Gest√£o (processos)", v: curW.G, c: COLORS.G},
    {k:"R", name:"Pesquisa (profundo)", v: curW.R, c: COLORS.R},
    {k:"E", name:"Extens√£o (campo)", v: curW.E, c: COLORS.E},
    {k:"I", name:"Inova√ß√£o (cria√ß√£o)", v: curW.I, c: COLORS.I}
  ].sort((a,b)=>b.v-a.v);

  const left=16, top=40, rowH=(H-62)/items.length, maxW=W-32;

  items.forEach((it, idx)=>{
    const y = top + idx*rowH + 10;

    ctx.fillStyle = COLORS.soft2;
    roundRect(ctx, left, y, maxW, 14, 8, true, false);

    ctx.fillStyle = it.c;
    roundRect(ctx, left, y, Math.round((it.v/100)*maxW), 14, 8, true, false);

    ctx.fillStyle = "rgba(15,23,42,.85)";
    ctx.font = "900 11px ui-sans-serif, system-ui";
    ctx.textAlign="left";
    ctx.fillText(`${EMOJI[it.k]} ${it.name}`, left, y-3);

    ctx.fillStyle = "rgba(15,23,42,.65)";
    ctx.font = "800 11px ui-sans-serif, system-ui";
    ctx.textAlign="right";
    ctx.fillText(`${it.v}%`, W-16, y+11);
  });

  ctx.textAlign="left";
  ctx.fillStyle = "rgba(15,23,42,.60)";
  ctx.font = "800 11px ui-sans-serif, system-ui";
  ctx.fillText(`Burocracia=${B}/100 ¬∑ Carga mental=${M}/100`, 16, H-10);
}

/* =========================
   NARRATIVA + PLANO + CHECKLIST
========================= */
function buildNarrative(data){
  const name = (val("name") || "Visitante").trim();
  const uni  = (val("uni") || "sua universidade").trim();
  const dept = (val("dept") || "seu departamento").trim();
  const prog = (val("prog") || "seu programa").trim();
  const hours = clampNum("hours",1,120);

  const core = topRole(data.cur);
  const desired = topRole({R:data.goal.R,E:data.goal.E,T:data.goal.T,G:data.goal.G,I:data.goal.I});
  const rk = riskLabel(data.capture);

  const biggestGap = Object.keys(data.gap).reduce((a,k)=> Math.abs(data.gap[k]) > Math.abs(data.gap[a]) ? k : a, "R");
  const gapAbs = Math.abs(data.gap[biggestGap]);
  const gapDir = data.gap[biggestGap] >= 0 ? "crescer" : "reduzir";

  const captureTxt =
    data.capture >= 70 ? "Seu sistema est√° em modo inc√™ndio. Se voc√™ n√£o redesenhar agenda e processos, sua identidade vira sobreviv√™ncia." :
    data.capture >= 40 ? "Voc√™ est√° no limite do sustent√°vel. Sem corte/automa√ß√£o, o essencial vira opcional." :
    "Sua carga parece administr√°vel, mas o risco √© crescer projeto sem criar processo. Previna.";

  const alignment =
    core===desired
      ? "Seu eixo atual conversa com seu desejo. Agora √© blindar tempo e transformar em ritual cont√≠nuo."
      : "Seu eixo atual n√£o conversa com seu desejo. Isso n√£o √© defeito: √© diagn√≥stico de custo invis√≠vel. O que voc√™ est√° sacrificando para sustentar o presente?";

  const txt = `
    <b>${name}</b> ‚Äî <b>${uni}</b> (${dept}; ${prog}) ¬∑ <b>${phaseTxt()}</b> ¬∑ <b>${hours}h/semana</b><br><br>
    Eixo atual: <b>${EMOJI[core]} ${LABEL[core]}</b> ¬∑ Eixo desejado: <b>${EMOJI[desired]} ${LABEL[desired]}</b><br>
    <b>${alignment}</b><br><br>
    <b>‚ö´ Burocracia:</b> ${data.cur.B}/100 (toler√¢ncia: ${data.goal.tolB}) ¬∑ <b>üß† Carga mental:</b> ${data.cur.M}/100 (toler√¢ncia: ${data.goal.tolM})<br>
    <b>Risco de captura:</b> <span style="color:${clsColor(rk.cls)}"><b>${rk.txt}</b></span> ‚Äî ${captureTxt}<br><br>
    Maior ajuste: <b>${gapDir}</b> em <b>${EMOJI[biggestGap]} ${LABEL[biggestGap]}</b> (~<b>${gapAbs}</b> pts).<br>
    A sa√≠da n√£o √© ‚Äútrabalhar mais‚Äù. √â <b>trabalhar com arquitetura</b>: agenda, processos, limites e delega√ß√£o.
  `;

  return {txt, core, desired, rk, biggestGap};
}

function buildMoves(data, meta){
  const moves=[];

  // ‚úÖ objetivo claro do ciclo
  moves.push({
    ttl:"üéØ Objetivo do ciclo (90 dias) ‚Äî o que muda de verdade",
    txt:`Meta 1: reduzir burocracia de ${data.cur.B}/100 para ‚â§ ${Math.max(0, data.goal.tolB)} e manter carga mental ‚â§ ${data.goal.tolM}.
Meta 2: aproximar o eixo desejado (${EMOJI[meta.desired]} ${LABEL[meta.desired]}) em +10 pontos no radar.
Evid√™ncias (o que voc√™ ter√° na m√£o): (1) biblioteca de templates + checklist, (2) 2 blocos semanais fixos de foco,
(3) 1 ritual cont√≠nuo do eixo (entrega semanal), (4) 1 mudan√ßa institucional (pauta/decis√£o/limite) que economize tempo real.`
  });

  moves.push({
    ttl:"48 horas ‚Äî parar a hemorragia (sem hero√≠smo)",
    txt:"1) Corte 1 reuni√£o sem decis√£o (ou reduza pela metade). 2) Crie 1 template para o dreno que mais se repete. 3) Bloqueie 2 sess√µes de foco (90‚Äì120 min) no melhor hor√°rio."
  });

  moves.push({
    ttl:"7 dias ‚Äî proteger o essencial",
    txt:"Defina seu ‚Äòhor√°rio sagrado‚Äô (foco). Crie pauta padr√£o para reuni√µes. Fa√ßa uma lista do que voc√™ N√ÉO faz. A burocracia precisa de limite formal."
  });

  const ritual = {
    R:"Pipeline semanal: pergunta‚Üídados‚Üírascunho‚Üísubmiss√£o. Uma micro-entrega/semana.",
    E:"Ritual mensal com parceiros fixos + 3 indicadores simples (n√£o s√≥ fotos).",
    T:"Uma disciplina vira ‚Äòlaborat√≥rio autoral‚Äô: casos, projetos, rubricas e feedback.",
    G:"Gest√£o com limite: agenda de gest√£o, decis√µes registradas, delega√ß√£o e encerramento de comiss√µes in√∫teis.",
    I:"Inova√ß√£o com usu√°rio: prot√≥tipo‚Üíteste‚Üíajuste. Depois institucionalize (manual + replica√ß√£o)."
  };
  moves.push({ ttl:"30 dias ‚Äî transformar eixo em ritual", txt: ritual[meta.desired] || "Crie um processo replic√°vel que sobreviva √† sua semana." });

  moves.push({
    ttl:"90 dias ‚Äî reequilibrar semana real vs ideal",
    txt:"Compare o gr√°fico Semana (Hoje vs Ideal). Fa√ßa 2 mudan√ßas estruturais: (a) reduzir reuni√µes, (b) automatizar relat√≥rio, (c) delegar rotina, (d) fechar uma frente. Refa√ßa o diagn√≥stico no dia 90."
  });

  if(data.capture >= 40){
    moves.push({
      ttl:"Plano antiburnout (objetivo, n√£o motivacional)",
      txt:"Sono e foco viram pol√≠tica. Tire reuni√µes do melhor hor√°rio cognitivo. Pare de aceitar urg√™ncia como normal. Sem isso, voc√™ perde ci√™ncia, ensino e sa√∫de."
    });
  }

  if(meta.core !== meta.desired){
    moves.push({
      ttl:"Ponte identit√°ria (do que voc√™ √© ao que quer ser)",
      txt:"Crie 1 projeto-ponte: seu eixo atual deve alimentar o desejado. Ex.: pesquisa ‚Üí ensino (aula autoral); ensino ‚Üí pesquisa (dados did√°ticos); extens√£o ‚Üí inova√ß√£o (ferramentas)."
    });
  }

  const gapAdvice = {
    R:"Crescer pesquisa = proteger escrita e reduzir frentes. Sem pipeline, tudo vira urg√™ncia.",
    E:"Crescer extens√£o = menos evento e mais continuidade (parceria + indicadores).",
    T:"Crescer ensino = autoria did√°tica (casos, projetos, rubricas) e inclus√£o real.",
    G:"Crescer gest√£o = decidir e delegar, n√£o ‚Äòsegurar tudo‚Äô. Gest√£o sem limite captura.",
    I:"Crescer inova√ß√£o = testar com usu√°rios e institucionalizar (sen√£o morre em voc√™)."
  };
  moves.push({ ttl:`Onde mexer primeiro: ${EMOJI[meta.biggestGap]} ${LABEL[meta.biggestGap]}`, txt: gapAdvice[meta.biggestGap] });

  return moves;
}

function buildChecklist(data, meta){
  const blocks = [];

  blocks.push({
    title:"üßØ 48 horas (anticaos)",
    hint:"A√ß√µes pequenas que mudam o sistema rapidamente.",
    items:[
      "Corte <b>1 reuni√£o</b> sem pauta/decis√£o (ou reduza pela metade).",
      "Crie <b>1 template</b> (e-mail, relat√≥rio, orienta√ß√£o, ata) para o dreno mais frequente.",
      "Bloqueie <b>2 sess√µes</b> de foco profundo (90‚Äì120 min) no melhor hor√°rio da semana.",
      "Escolha <b>1 tarefa</b> repetitiva e transforme em checklist (passo a passo).",
      "Tire notifica√ß√µes por <b>4 horas</b> no per√≠odo de foco."
    ]
  });

  blocks.push({
    title:"üìå 7 dias (blindagem)",
    hint:"Sem blindagem, o essencial vira ‚Äòquando der‚Äô.",
    items:[
      "Defina seu <b>hor√°rio sagrado</b> (foco) e trate como aula.",
      "Regra: reuni√£o s√≥ com <b>pauta + sa√≠da</b> (decis√£o registrada).",
      "Liste o que voc√™ <b>n√£o faz</b> (limites formais).",
      "Delegue <b>1 rotina</b> (padr√£o de qualidade + acompanhamento).",
      "Reserve 20 min para <b>organizar arquivos</b> do projeto (estrutura simples)."
    ]
  });

  blocks.push({
    title:"üß≠ 30 dias (ritual do eixo)",
    hint:"Ritual √© continuidade. Continuidade √© poder acad√™mico.",
    items:[
      `Transforme <b>${LABEL[meta.desired]}</b> em processo: uma entrega semanal pequena.`,
      "Documente seu projeto em 1 p√°gina: <b>objetivo, p√∫blico, rotina, indicadores, entregas</b>.",
      "Defina <b>3 indicadores</b> √∫teis (sem burocracia vazia).",
      "Crie uma rotina de <b>revis√£o quinzenal</b> do que entra e do que sai da agenda.",
      "Mantenha um <b>di√°rio de decis√µes</b> (o que aceitou/recusou e por qu√™)."
    ]
  });

  blocks.push({
    title:"üèÅ 90 dias (equil√≠brio)",
    hint:"Se depois de 90 dias nada mudou, o sistema ganhou.",
    items:[
      "Redesenhe a semana para reduzir <b>Burocracia</b> em pelo menos 10 pontos.",
      "Mova reuni√µes para hor√°rios de <b>baixo desempenho cognitivo</b>.",
      "Feche 1 frente aberta que n√£o conversa com sua meta.",
      "Crie estrat√©gia de <b>orienta√ß√µes</b> (grupo, templates, encontros tem√°ticos).",
      "Refa√ßa este diagn√≥stico e compare os gr√°ficos."
    ]
  });

  blocks.push({
    title:"ü§ù Inclus√£o real (neurodiverg√™ncia e acessibilidade)",
    hint:"Isso n√£o √© ‚Äòextra‚Äô: √© qualidade do ensino.",
    items:[
      "Estrutura previs√≠vel (agenda, metas, pausas).",
      "M√∫ltiplas formas de participa√ß√£o (fala, texto, an√¥nimo, grupo).",
      "Acessibilidade b√°sica: <b>contraste, fontes leg√≠veis, texto alternativo</b>.",
      "Regras de conviv√™ncia: respeito, tempo de fala, acolhimento.",
      "Rubricas claras + feedback curto (evita sofrimento e injusti√ßa)."
    ]
  });

  blocks.push({
    title:"ü§ñ IA (√©tica + pedagogia)",
    hint:"IA sem regra vira ru√≠do; com regra vira ferramenta.",
    items:[
      "Defina o que pode (rascunho, revis√£o, explica√ß√£o) com <b>declara√ß√£o de uso</b>.",
      "Defina o que n√£o pode (resposta final sem autoria e sem refer√™ncia).",
      "Mostre exemplos bons e ruins (transpar√™ncia).",
      "Exija fontes reais e checagem (n√£o s√≥ texto bonito).",
      "Use IA para reduzir burocracia (templates) e liberar tempo de qualidade."
    ]
  });

  blocks.push({
    title:"üß† Sa√∫de mental (sem romantizar)",
    hint:"Professor quebrado n√£o sustenta projeto nem gente.",
    items:[
      "Proteja sono como pol√≠tica (sem culpa).",
      "Crie janelas de resposta a e-mails (urg√™ncia n√£o √© padr√£o).",
      "Uma conversa real sobre sa√∫de mental na turma/equipe.",
      "Tire 1 atividade do calend√°rio (redu√ß√£o consciente).",
      "Um turno sem universidade por semana (se imposs√≠vel, o diagn√≥stico est√° certo)."
    ]
  });

  blocks.push({
    title:"‚ö´ Antiburocracia (engenharia)",
    hint:"Burocracia inevit√°vel ‚â† burocracia dominante.",
    items:[
      "Biblioteca de templates (atas, relat√≥rios, e-mails, orienta√ß√µes).",
      "Padr√£o de arquivos do projeto (nomea√ß√£o + pastas).",
      "Reuni√£o sem decis√£o n√£o existe: encerre em 15 minutos.",
      "Recorrente vira processo: checklist + respons√°vel + prazo.",
      "Diga ‚Äòn√£o‚Äô elegante: posso em X / posso se for Y / n√£o posso por Z."
    ]
  });

  return blocks;
}

function renderChecklist(blocks){
  const grid = document.getElementById("checkGrid");
  grid.innerHTML = "";
  blocks.forEach(b=>{
    const card = document.createElement("div");
    card.className = "checkCard";
    card.innerHTML = `<h3>${b.title}</h3><p class="hint">${b.hint}</p>`;
    b.items.forEach(txt=>{
      const row = document.createElement("div");
      row.className = "ck";
      row.innerHTML = `<input type="checkbox"><div class="txt">${txt}</div>`;
      card.appendChild(row);
    });
    grid.appendChild(card);
  });

  document.getElementById("closing").innerHTML = `
    <div style="line-height:1.65; font-size:13px; color:rgba(15,23,42,.92);">
      <b>1)</b> Professor universit√°rio n√£o √© ‚Äúfun√ß√£o‚Äù: √© um <b>ecossistema de decis√µes</b> sobre tempo, sentido e compromisso p√∫blico.<br>
      <b>2)</b> Pesquisa sem ensino vira especializa√ß√£o muda; ensino sem pesquisa vira repeti√ß√£o; extens√£o sem criticidade vira evento; gest√£o sem limite vira captura; inova√ß√£o sem institui√ß√£o vira hobby.<br>
      <b>3)</b> A universidade mede o que voc√™ consegue <b>registrar</b> ‚Äî seu trabalho √© n√£o virar ref√©m do registro.<br>
      <b>4)</b> O recurso mais raro √© <b>aten√ß√£o</b>. A sobreviv√™ncia docente √© arquitetura: agenda, processos e limites.<br>
      <b>5)</b> O professor maduro n√£o ‚Äúfaz tudo‚Äù: ele <b>forma pessoas</b> e cria estruturas para o trabalho sobreviver ao seu nome.
    </div>
  `;
}

/* =========================
   TABS
========================= */
document.querySelectorAll(".tab[data-tab]").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab[data-tab]").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const tab = t.dataset.tab;
    document.getElementById("tab-responder").style.display = (tab==="responder") ? "" : "none";
    document.getElementById("tab-metas").style.display = (tab==="metas") ? "" : "none";
    document.getElementById("tab-perguntas").style.display = (tab==="perguntas") ? "" : "none";
  });
});
document.querySelectorAll(".tab[data-rtab]").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab[data-rtab]").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const tab = t.dataset.rtab;
    document.getElementById("rtab-resultados").style.display = (tab==="resultados") ? "" : "none";
    document.getElementById("rtab-plano").style.display = (tab==="plano") ? "" : "none";
    document.getElementById("rtab-check").style.display = (tab==="check") ? "" : "none";
  });
});

/* =========================
   RUN + RENDER
========================= */
const statusPill = document.getElementById("statusPill");

function run(){
  const data = compute();
  if(data.missing.length){
    statusPill.textContent = `faltam ${data.missing.length} respostas`;
    statusPill.style.background = "rgba(245,158,11,.12)";
    statusPill.style.borderColor = "rgba(245,158,11,.25)";
    document.getElementById("story").innerHTML =
      `Faltam respostas nas quest√µes: <b>${data.missing.join(", ")}</b>. V√° na aba <b>Perguntas</b> e complete.`;
    return;
  }

  const meta = buildNarrative(data);
  const moves = buildMoves(data, meta);
  const blocks = buildChecklist(data, meta);

  document.getElementById("kpiCore").textContent = `${EMOJI[meta.core]} ${LABEL[meta.core]}`;
  const r = riskLabel(data.capture);
  document.getElementById("kpiRisk").textContent = r.txt;
  document.getElementById("kpiRisk").style.color = clsColor(r.cls);

  document.getElementById("story").innerHTML = meta.txt;
  document.getElementById("quote").innerHTML = `
    <b>Tr√™s ideias para debate (sem autoajuda):</b><br>
    ‚Ä¢ A universidade te puxa para ser <b>operador de processos</b>. Voc√™ decide se aceita essa identidade.<br>
    ‚Ä¢ O docente que n√£o protege aten√ß√£o vira ‚Äúprodutor de ru√≠do‚Äù: responde tudo, mas constr√≥i pouco.<br>
    ‚Ä¢ Sa√∫de mental n√£o √© ‚Äúpessoal‚Äù: √© <b>institucional</b>. Se a institui√ß√£o te adoece, ela tamb√©m adoece sua ci√™ncia e seu ensino.
  `;

  const movesEl = document.getElementById("moves");
  movesEl.innerHTML = "";
  moves.forEach(m=>{
    const d = document.createElement("div");
    d.className = "move";
    d.innerHTML = `<p class="ttl">${m.ttl}</p><p class="txt">${m.txt.replaceAll("\n","<br>")}</p>`;
    movesEl.appendChild(d);
  });

  renderChecklist(blocks);

  // charts
  drawRadar(data.cur, {R:data.goal.R,E:data.goal.E,T:data.goal.T,G:data.goal.G,I:data.goal.I});
  drawWeekBars(data.currentWeek, data.ideal);

  const bColor = data.cur.B>=70 ? "rgba(239,68,68,.80)" : (data.cur.B>=40 ? "rgba(245,158,11,.85)" : "rgba(22,163,74,.80)");
  drawGauge("cvBureau", data.cur.B, `Burocracia: ${data.cur.B}/100 (fric√ß√£o +${data.frictionB})`, bColor);

  const mColor = data.cur.M>=70 ? "rgba(239,68,68,.80)" : (data.cur.M>=40 ? "rgba(245,158,11,.85)" : "rgba(22,163,74,.80)");
  drawGauge("cvMental", data.cur.M, `Carga mental: ${data.cur.M}/100 (acima do limite +${data.frictionM})`, mColor);

  drawQuad(data.impact, data.energy);
  drawFunnel(data.currentWeek, data.cur.B, data.cur.M);

  statusPill.textContent = "diagn√≥stico gerado";
  statusPill.style.background = "rgba(22,163,74,.12)";
  statusPill.style.borderColor = "rgba(22,163,74,.25)";
}

document.getElementById("btnRun").addEventListener("click", run);
document.getElementById("btnRun2").addEventListener("click", run);

// Redesenhar ao redimensionar
window.addEventListener("resize", ()=>{
  if(countAnswered() === QUESTIONS.length){
    run();
  }else{
    drawRadar({R:0,E:0,T:0,G:0,I:0},{R:0,E:0,T:0,G:0,I:0});
    drawWeekBars({R:0,E:0,T:0,G:0,I:0,B:0},{R:0,E:0,T:0,G:0,I:0,B:0});
    drawGauge("cvBureau", 0, "Burocracia: 0/100", "rgba(22,163,74,.80)");
    drawGauge("cvMental", 0, "Carga mental: 0/100", "rgba(22,163,74,.80)");
    drawQuad({R:0,E:0,T:0,G:0,I:0},{R:0,E:0,T:0,G:0,I:0});
    drawFunnel({R:0,E:0,T:0,G:0,I:0,B:0},0,0);
  }
});

/* =========================
   QUAD INTERACTION (hover/click/pan/zoom)
========================= */
(function enableQuadInteraction(){
  const canvas = document.getElementById("cvQuad");

  function screenToWorld(sx, sy){
    const W = canvas.getBoundingClientRect().width;
    const H = canvas.getBoundingClientRect().height;

    let x = sx - QuadUI.offX;
    let y = sy - QuadUI.offY;

    x = (x - W/2)/QuadUI.scale + W/2;
    y = (y - H/2)/QuadUI.scale + H/2;

    return {x,y};
  }

  function pickPoint(sx, sy){
    const pts = canvas.__quadPts || [];
    const w = screenToWorld(sx, sy);
    let best = null;
    let bestD = 1e9;

    pts.forEach(p=>{
      const dx = p.px - w.x;
      const dy = p.py - w.y;
      const d = Math.sqrt(dx*dx + dy*dy);
      if(d < bestD){
        bestD = d;
        best = p;
      }
    });

    if(best && bestD <= 18){
      return {...best, sx, sy};
    }
    return null;
  }

  canvas.addEventListener("mousemove", (e)=>{
    const r = canvas.getBoundingClientRect();
    const sx = e.clientX - r.left;
    const sy = e.clientY - r.top;
    QuadUI.hover = pickPoint(sx, sy);
    if(countAnswered() === QUESTIONS.length) run();
  });

  canvas.addEventListener("click", (e)=>{
    const r = canvas.getBoundingClientRect();
    const sx = e.clientX - r.left;
    const sy = e.clientY - r.top;
    const p = pickPoint(sx, sy);
    if(QuadUI.pinned && (!p || p.k === QuadUI.pinned.k)){
      QuadUI.pinned = null;
    }else{
      QuadUI.pinned = p;
    }
    if(countAnswered() === QUESTIONS.length) run();
  });

  canvas.addEventListener("dblclick", ()=>{
    QuadUI.scale = 1;
    QuadUI.offX = 0;
    QuadUI.offY = 0;
    QuadUI.pinned = null;
    if(countAnswered() === QUESTIONS.length) run();
  });

  canvas.addEventListener("wheel", (e)=>{
    e.preventDefault();
    const delta = Math.sign(e.deltaY);
    const factor = (delta > 0) ? 0.92 : 1.08;
    QuadUI.scale = Math.max(0.8, Math.min(2.6, QuadUI.scale * factor));
    if(countAnswered() === QUESTIONS.length) run();
  }, {passive:false});

  canvas.addEventListener("pointerdown", (e)=>{
    canvas.setPointerCapture(e.pointerId);
    QuadUI.dragging = true;
    QuadUI.lastX = e.clientX;
    QuadUI.lastY = e.clientY;
  });

  canvas.addEventListener("pointermove", (e)=>{
    if(!QuadUI.dragging) return;
    const dx = e.clientX - QuadUI.lastX;
    const dy = e.clientY - QuadUI.lastY;
    QuadUI.lastX = e.clientX;
    QuadUI.lastY = e.clientY;
    QuadUI.offX += dx;
    QuadUI.offY += dy;
    if(countAnswered() === QUESTIONS.length) run();
  });

  canvas.addEventListener("pointerup", ()=>{
    QuadUI.dragging = false;
  });

  canvas.addEventListener("pointerleave", ()=>{
    QuadUI.hover = null;
    if(countAnswered() === QUESTIONS.length) run();
  });
})();

/* =========================
   SAVE / LOAD
========================= */
function collectState(){
  const answers = {};
  QUESTIONS.forEach(q=>{ answers[q.id] = document.getElementById(q.id).value || ""; });
  return {
    name: val("name"), uni: val("uni"), dept: val("dept"), prog: val("prog"),
    phase: val("phase"), hours: val("hours"), notes: val("notes"),
    goalR: val("goalR"), goalE: val("goalE"), goalT: val("goalT"),
    goalG: val("goalG"), goalI: val("goalI"), tolB: val("tolB"), tolM: val("tolM"),
    idealR: val("idealR"), idealE: val("idealE"), idealT: val("idealT"),
    idealG: val("idealG"), idealI: val("idealI"), idealB: val("idealB"),
    answers
  };
}
function applyState(s){
  if(!s) return;
  setVal("name", s.name); setVal("uni", s.uni); setVal("dept", s.dept); setVal("prog", s.prog);
  setVal("phase", s.phase || "early"); setVal("hours", s.hours || 45); setVal("notes", s.notes || "");
  setVal("goalR", s.goalR ?? 70); setVal("goalE", s.goalE ?? 75); setVal("goalT", s.goalT ?? 70);
  setVal("goalG", s.goalG ?? 40); setVal("goalI", s.goalI ?? 60);
  setVal("tolB", s.tolB ?? 35); setVal("tolM", s.tolM ?? 45);
  setVal("idealR", s.idealR ?? 25); setVal("idealE", s.idealE ?? 25); setVal("idealT", s.idealT ?? 25);
  setVal("idealG", s.idealG ?? 15); setVal("idealI", s.idealI ?? 10); setVal("idealB", s.idealB ?? 15);

  if(s.answers){
    Object.keys(s.answers).forEach(id=>{
      const el = document.getElementById(id);
      if(el){
        el.value = s.answers[id] || "1";
        const vbox = document.getElementById(id+"_v");
        if(vbox) vbox.textContent = el.value ? el.value : "1";
      }
    });
  }
  updateProgress();
}

document.getElementById("btnSave").addEventListener("click", ()=>{
  localStorage.setItem("eco_docente_v31", JSON.stringify(collectState()));
  statusPill.textContent = "salvo";
  statusPill.style.background = "rgba(37,99,235,.10)";
  statusPill.style.borderColor = "rgba(37,99,235,.20)";
});
document.getElementById("btnLoad").addEventListener("click", ()=>{
  const raw = localStorage.getItem("eco_docente_v31");
  if(!raw){
    statusPill.textContent = "nada salvo";
    statusPill.style.background = "rgba(245,158,11,.12)";
    statusPill.style.borderColor = "rgba(245,158,11,.25)";
    return;
  }
  applyState(JSON.parse(raw));
  statusPill.textContent = "carregado";
  statusPill.style.background = "rgba(37,99,235,.10)";
  statusPill.style.borderColor = "rgba(37,99,235,.20)";
  if(countAnswered() === QUESTIONS.length) run();
});
document.getElementById("btnReset").addEventListener("click", ()=>{
  localStorage.removeItem("eco_docente_v31");
  location.reload();
});

/* =========================
   EXPORT (TODOS os 6 gr√°ficos)
========================= */
document.getElementById("btnExport").addEventListener("click", ()=>{
  if(countAnswered() !== QUESTIONS.length){
    alert("Complete as perguntas antes de exportar.");
    return;
  }

  const canvases = [
    { id:"cvRadar",  title:"Perfil (Atual vs Desejado)" },
    { id:"cvWeek",   title:"Semana (Hoje vs Ideal)" },
    { id:"cvBureau", title:"Burocracia" },
    { id:"cvMental", title:"Sa√∫de mental" },
    { id:"cvQuad",   title:"Impacto √ó Energia" },
    { id:"cvFunnel", title:"Funil de drenos" }
  ];

  const out = document.createElement("canvas");
  out.width = 1900;
  out.height = 1350;
  const ctx = out.getContext("2d");

  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,out.width,out.height);

  ctx.fillStyle="rgba(15,23,42,.95)";
  ctx.font="950 36px ui-sans-serif, system-ui";
  ctx.fillText("Ecossistema Docente ‚Äî Painel", 36, 54);

  ctx.fillStyle="rgba(15,23,42,.65)";
  ctx.font="800 16px ui-sans-serif, system-ui";
  const name = (val("name")||"Visitante").trim();
  const uni  = (val("uni")||"‚Äî").trim();
  const dept = (val("dept")||"‚Äî").trim();
  ctx.fillText(`${name} ¬∑ ${uni} ¬∑ ${dept} ¬∑ ${new Date().toLocaleDateString()}`, 36, 82);

  const pad = 36;
  const top = 110;
  const gap = 22;
  const cellW = (out.width - pad*2 - gap)/2;
  const cellH = (out.height - top - pad - gap*2)/3;

  canvases.forEach((c, idx)=>{
    const src = document.getElementById(c.id);
    const col = idx % 2;
    const row = Math.floor(idx / 2);
    const x = pad + col*(cellW + gap);
    const y = top + row*(cellH + gap);

    ctx.fillStyle="rgba(15,23,42,.03)";
    ctx.strokeStyle="rgba(15,23,42,.10)";
    ctx.lineWidth=1;
    roundRect(ctx, x, y, cellW, cellH, 14, true, true);

    ctx.fillStyle="rgba(15,23,42,.80)";
    ctx.font="900 14px ui-sans-serif, system-ui";
    ctx.fillText(c.title, x+12, y+22);

    const innerX = x+12;
    const innerY = y+34;
    const innerW = cellW-24;
    const innerH = cellH-46;
    ctx.drawImage(src, innerX, innerY, innerW, innerH);
  });

  const link = document.createElement("a");
  link.download = "ecossistema-docente-painel.png";
  link.href = out.toDataURL("image/png");
  link.click();
});

/* =========================
   INIT
========================= */
function initPlaceholders(){
  drawRadar({R:0,E:0,T:0,G:0,I:0},{R:0,E:0,T:0,G:0,I:0});
  drawWeekBars({R:0,E:0,T:0,G:0,I:0,B:0},{R:0,E:0,T:0,G:0,I:0,B:0});
  drawGauge("cvBureau", 0, "Burocracia: 0/100", "rgba(22,163,74,.80)");
  drawGauge("cvMental", 0, "Carga mental: 0/100", "rgba(22,163,74,.80)");
  drawQuad({R:0,E:0,T:0,G:0,I:0},{R:0,E:0,T:0,G:0,I:0});
  drawFunnel({R:0,E:0,T:0,G:0,I:0,B:0},0,0);
}
initPlaceholders();

// auto-load
const saved = localStorage.getItem("eco_docente_v31");
if(saved){
  applyState(JSON.parse(saved));
  if(countAnswered() === QUESTIONS.length) run();
}

/* =========================
   FIX: progress update when typing basic fields (optional)
========================= */
["name","uni","dept","prog","hours"].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener("input", ()=>{ /* no-op */ });
});
</script>
</body>
</html>
